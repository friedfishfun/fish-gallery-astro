---
import { getBlogList, getCategoryList } from "@libs/microcms.ts";
import Layout from "@layouts/Layout.astro";
import BlogList from "@components/BlogList.astro";
import CategoryList from "@components/CategoryList.astro";
import { LIMIT } from "@constants/index.ts";
import { getSettings } from "@libs/microcms.ts";

export const prerender = true;

const settings = await getSettings();

const { contents: blogs } = await getBlogList({
  limit: LIMIT,
});

// content_type ãŒã€Œé…åˆ—ï¼ˆä»Šå›ï¼‰ã€ã§ã‚‚ã€Œæ–‡å­—åˆ—ã€ã§ã‚‚è½ã¡ãªã„ã‚ˆã†ã«å¸å
const typeOf = (blog) => {
  const t = blog?.content_type;

  if (t == null) return "";

  // ä¾‹: ["culture"] / ["sakanakara"] / ["culture","sakanakara"]
  if (Array.isArray(t)) {
    return t
      .filter((x) => typeof x === "string")
      .map((x) => x.trim())
      .filter(Boolean)
      .join("|"); // "culture|sakanakara"
  }

  if (typeof t === "string") return t.trim();

  // å¿µã®ãŸã‚ï¼šã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå‹ã§æ¥ã‚‹å¯èƒ½æ€§ã‚‚å¸å
  if (typeof t === "object") {
    const v = t.id ?? t.value ?? t.name ?? t.label ?? t.key;
    return typeof v === "string" ? v.trim() : "";
  }

  return "";
};

const hasType = (blog, key) => typeOf(blog).split("|").includes(key);

// ã‚¿ã‚¤ãƒ—åˆ¥ã«åˆ†ã‘ã‚‹
const culturePost = blogs.find((blog) => hasType(blog, "culture"));
const sakanakaraPosts = blogs.filter((blog) => hasType(blog, "sakanakara"));

// ğŸ‘‡ culturePost ãŒã‚®ãƒ£ãƒ©ãƒªãƒ¼ã«æ··ã–ã‚‰ãªã„ã‚ˆã† â€œIDã§ç¢ºå®Ÿã«é™¤å¤–â€
const otherPosts = blogs.filter((blog) => {
  if (culturePost && blog.id === culturePost.id) return false;
  if (hasType(blog, "sakanakara")) return false;
  return true;
});

const { contents: categories } = await getCategoryList();

const Meta = {
  title: settings?.title || "Set Your Title Here",
};
---

<Layout Meta={Meta}>
  <div class="space-y-16">
    <!-- ä¸Šæ®µï¼šæ–‡åŒ–å®£è¨€ -->
    {culturePost && (
      <section>
        <h2 class="text-3xl font-bold mb-4">é­šæšã’æ–‡åŒ–å®£è¨€</h2>
        <a
          href={`/blog/${culturePost.id}`}
          class="block border p-6 rounded-lg hover:bg-gray-50 transition"
        >
          <h3 class="text-2xl font-semibold mb-2">{culturePost.title}</h3>
          <p class="text-gray-600">ç¶šãã‚’èª­ã‚€ â†’</p>
        </a>
      </section>
    )}

    <!-- ä¸­æ®µï¼šã‚µã‚«ãƒŠã‚«ãƒ© -->
    {sakanakaraPosts.length > 0 && (
      <section>
        <h2 class="text-3xl font-bold mb-4">ã‚µã‚«ãƒŠã‚«ãƒ©</h2>
        <BlogList blogs={sakanakaraPosts} />
      </section>
    )}

    <!-- ä¸‹æ®µï¼šãã®ä»– -->
    {otherPosts.length > 0 && (
      <section>
        <h2 class="text-3xl font-bold mb-4">ã‚®ãƒ£ãƒ©ãƒªãƒ¼</h2>
        <BlogList blogs={otherPosts} />
      </section>
    )}
  </div>

  <div class="space-y-8 mt-16">
    <CategoryList categories={categories} />
  </div>
</Layout>
